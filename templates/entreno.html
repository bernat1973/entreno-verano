from datetime import datetime, date, timedelta

class Ejercicios:
    def __init__(self, modelo):
        self.modelo = modelo
        # Definición de ejercicios por categoría
        self.bodyweight_ejercicios = [
            'Elevaciones de piernas suaves', 'Plancha lateral con apoyo en antebrazo',
            'Flexiones estándar con manos anchas', 'Flexiones pica para hombros',
            'Saltos patinador con cambio lento', 'Abdominales isométricos de contracción'
        ]
        self.weights_ejercicios = [
            'Press de banca con mancuernas', 'Remo con barra', 'Sentadilla con peso',
            'Press militar con mancuernas', 'Curl de bíceps con barra'
        ]
        self.nueva_bodyweight_ejercicios = [
            'Wiper (piernas a 90°)', 'Russian Twist (sin peso)', 'Heel Toucher',
            'Rotacional Punch Up', 'Plancha con elevación de pierna'
        ]
        self.mixta_ejercicios = [
            'Flexiones con peso adicional', 'Zancadas con mancuernas',
            'Plancha con mancuerna', 'Abdominales con peso'
        ]
        # Puntos por ejercicio base
        self.puntos_base = {
            'elevaciones de piernas suaves': 5, 'plancha lateral con apoyo en antebrazo': 5,
            'flexiones estándar con manos anchas': 5, 'flexiones pica para hombros': 5,
            'saltos patinador con cambio lento': 5, 'abdominales isométricos de contracción': 6,
            'press de banca con mancuernas': 8, 'remo con barra': 8, 'sentadilla con peso': 10,
            'press militar con mancuernas': 7, 'curl de bíceps con barra': 6,
            'wiper (piernas a 90°)': 6, 'russian twist (sin peso)': 5, 'heel toucher': 5,
            'rotacional punch up': 6, 'plancha con elevación de pierna': 7,
            'flexiones con peso adicional': 7, 'zancadas con mancuernas': 8,
            'plancha con mancuerna': 7, 'abdominales con peso': 6
        }

    def get_base_exercise_name(self, ejercicio):
        """Devuelve el nombre base del ejercicio eliminando series o modificadores."""
        base_name = ejercicio.lower().split('(')[0].strip()
        return next((key for key in self.puntos_base.keys() if key in base_name), base_name)

    def get_puntos(self, ejercicio_base):
        """Devuelve los puntos asociados a un ejercicio base."""
        return self.puntos_base.get(ejercicio_base.lower(), 0)

    def get_todos_ejercicios(self):
        """Devuelve una lista con todos los ejercicios de todas las categorías."""
        return (self.bodyweight_ejercicios + self.weights_ejercicios + 
                self.nueva_bodyweight_ejercicios + self.mixta_ejercicios)

    def _calcular_progreso_ciclo(self, fecha):
        """Calcula el progreso del ciclo basado en la fecha."""
        inicio_ciclo = date(2025, 6, 1)  # Inicio del ciclo de verano
        dias_transcurridos = (fecha - inicio_ciclo).days
        return min(dias_transcurridos // 7 + 1, 12)  # Máximo 12 semanas

    def get_ejercicios_dia(self, fecha, historial_semanal=None):
        """Devuelve los ejercicios recomendados para un día específico."""
        try:
            if historial_semanal is None:
                historial_semanal = self.modelo.historial_semanal
            progreso_ciclo = self._calcular_progreso_ciclo(fecha)
            semana_inicio = fecha - timedelta(days=fecha.weekday())
            semana_str = semana_inicio.strftime('%Y-%m-%d')

            # Seleccionar ejercicios según la categoría de entrenamiento
            if self.modelo.categoria_entrenamiento == "bodyweight":
                ejercicios_base = self.bodyweight_ejercicios
            elif self.modelo.categoria_entrenamiento == "weights":
                ejercicios_base = self.weights_ejercicios
            elif self.modelo.categoria_entrenamiento == "nueva_bodyweight":
                ejercicios_base = self.nueva_bodyweight_ejercicios
            elif self.modelo.categoria_entrenamiento == "mixta":
                ejercicios_base = self.mixta_ejercicios
            else:
                ejercicios_base = self.bodyweight_ejercicios  # Valor por defecto

            # Generar ejercicios progresivos según el ciclo
            ejercicios_progresivos = []
            for ejercicio in ejercicios_base:
                series = 3
                repeticiones = 10 if progreso_ciclo < 6 else 15 if progreso_ciclo < 10 else 20
                tiempo = 60 if "plancha" in ejercicio.lower() or "abdominales" in ejercicio.lower() else None
                if tiempo:
                    ejercicio_progresivo = f"{series} series de {tiempo} segundos {ejercicio}"
                else:
                    ejercicio_progresivo = f"{series} series de {repeticiones} {ejercicio}"
                ejercicios_progresivos.append(ejercicio_progresivo)

            return ejercicios_progresivos
        except Exception as e:
            print(f"[DEBUG] Error en get_ejercicios_dia: {e}")
            return []
