<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe Semanal - Entreno Verano</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <h1>Informe Semanal - {{ fecha|default('Sin fecha') }}</h1>

            <div class="card">
                {% for semana, grupos in informe.items()|default({}) %}
                    <h2>{{ semana }}</h2>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Grupo Muscular</th>
                                <th>Ejercicios Realizados</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Grupos musculares fijos -->
                            {% set grupos_fijos = ['pectorales', 'espalda', 'abdominales', 'hombros', 'brazos', 'piernas', 'core', 'otros'] %}
                            {% for grupo in grupos_fijos %}
                                <tr>
                                    <td>{{ grupo|capitalize }}</td>
                                    <td>
                                        {% if grupos[grupo] %}
                                            <ul style="margin: 0; padding-left: 20px;">
                                                {% for ej in grupos[grupo] %}
                                                    <li>{{ ej }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            Ninguno
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if semanas_puntos and semanas_puntos|length > 0 and loop.index0 < semanas_puntos|length %}
                        <p><strong>Total Puntos:</strong> {{ semanas_puntos[loop.index0].puntos|default(0) }}</p>
                    {% else %}
                        <p><strong>Total Puntos:</strong> 0</p>
                    {% endif %}
                    {% if semanas_km and semanas_km|length > 0 and loop.index0 < semanas_km|length %}
                        <p><strong>Total Kilómetros:</strong> {{ semanas_km[loop.index0].km|default(0) }} km</p>
                    {% else %}
                        <p><strong>Total Kilómetros:</strong> 0 km</p>
                    {% endif %}
                    <p><strong>Entrenamientos completados:</strong> {{ modelo.contador_progresion | default(0) }}</p>
                {% endfor %}
            </div>

            <!-- Gráficas de Datos Personales -->
            <div class="card">
                <h3>Evolución de Crecimiento</h3>
                <div class="grafica-container">
                    <canvas id="estaturaChart"></canvas>
                </div>
                <div class="grafica-container mt-4">
                    <canvas id="velocidadChart"></canvas>
                </div>
            </div>

            <!-- Gráfica de Puntos -->
            <div class="card">
                <h3>Evolución de Puntos</h3>
                <div class="grafica-container">
                    <canvas id="puntosChart"></canvas>
                </div>
            </div>

            <!-- Gráfica de Correr (Kilómetros) -->
            <div class="card">
                <h3>Evolución de Kilómetros</h3>
                <div class="grafica-container">
                    <canvas id="kmChart"></canvas>
                </div>
            </div>

            <a href="{{ url_for('resumen') }}" class="btn btn-primary">Volver a Resumen</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% if datos_grafica and datos_grafica|length > 0 %}
                const datosJSON = {{ datos_grafica|tojson|safe }};
                const labels = datosJSON.map(d => d.mes || 'Sin fecha');
                const estaturaData = datosJSON.map(d => d.estatura || 0);
                const velocidadData = datosJSON.map(d => d.velocidad || 0);

                // Gráfica de Estatura
                const estaturaCtx = document.getElementById('estaturaChart').getContext('2d');
                new Chart(estaturaCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Estatura (cm)',
                            data: estaturaData,
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: { display: true, text: 'Estatura (cm)' },
                                ticks: {
                                    stepSize: 0.5
                                }
                            }
                        },
                        plugins: { legend: { position: 'top' } }
                    }
                });

                // Gráfica de Velocidad
                const velocidadCtx = document.getElementById('velocidadChart').getContext('2d');
                new Chart(velocidadCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Crecimiento Mensual (cm)',
                            data: velocidadData,
                            borderColor: '#FF6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Crecimiento Mensual (cm)' },
                                ticks: {
                                    stepSize: 0.5
                                }
                            }
                        },
                        plugins: { legend: { position: 'top' } }
                    }
                });
            {% else %}
                // Placeholder si no hay datos de crecimiento
                const estaturaCtx = document.getElementById('estaturaChart').getContext('2d');
                new Chart(estaturaCtx, {
                    type: 'line',
                    data: { labels: ['Sin datos'], datasets: [{ label: 'Estatura (cm)', data: [0], borderColor: '#36A2EB', backgroundColor: 'rgba(54, 162, 235, 0.2)', fill: true }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
                });
                const velocidadCtx = document.getElementById('velocidadChart').getContext('2d');
                new Chart(velocidadCtx, {
                    type: 'line',
                    data: { labels: ['Sin datos'], datasets: [{ label: 'Crecimiento Mensual (cm)', data: [0], borderColor: '#FF6384', backgroundColor: 'rgba(255, 99, 132, 0.2)', fill: true }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            {% endif %}

            {% if semanas_puntos and semanas_puntos|length > 0 %}
                const puntosLabels = {{ semanas_puntos|map(attribute='inicio_semana')|list|tojson|safe }};
                const puntosData = {{ semanas_puntos|map(attribute='puntos')|list|default([0])|tojson|safe }};

                // Gráfica de Puntos
                const puntosCtx = document.getElementById('puntosChart').getContext('2d');
                new Chart(puntosCtx, {
                    type: 'bar',
                    data: {
                        labels: puntosLabels.map(date => new Date(date).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })),
                        datasets: [{
                            label: 'Puntos',
                            data: puntosData,
                            backgroundColor: '#4BC0C0',
                            borderColor: '#4BC0C0',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Puntos' }
                            }
                        },
                        plugins: { legend: { position: 'top' } }
                    }
                });
            {% else %}
                // Placeholder si no hay datos de puntos
                const puntosCtx = document.getElementById('puntosChart').getContext('2d');
                new Chart(puntosCtx, {
                    type: 'bar',
                    data: { labels: ['Sin datos'], datasets: [{ label: 'Puntos', data: [0], backgroundColor: '#4BC0C0' }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            {% endif %}

            {% if semanas_km and semanas_km|length > 0 %}
                const kmLabels = {{ semanas_km|map(attribute='inicio_semana')|list|tojson|safe }};
                const kmData = {{ semanas_km|map(attribute='km')|list|default([0])|tojson|safe }};

                // Gráfica de Kilómetros
                const kmCtx = document.getElementById('kmChart').getContext('2d');
                new Chart(kmCtx, {
                    type: 'line',
                    data: {
                        labels: kmLabels.map(date => new Date(date).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })),
                        datasets: [{
                            label: 'Kilómetros',
                            data: kmData,
                            borderColor: '#FF9F40',
                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Kilómetros' }
                            }
                        },
                        plugins: { legend: { position: 'top' } }
                    }
                });
            {% else %}
                // Placeholder si no hay datos de kilómetros
                const kmCtx = document.getElementById('kmChart').getContext('2d');
                new Chart(kmCtx, {
                    type: 'line',
                    data: { labels: ['Sin datos'], datasets: [{ label: 'Kilómetros', data: [0], borderColor: '#FF9F40', backgroundColor: 'rgba(255, 159, 64, 0.2)', fill: true }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            {% endif %}
        });
    </script>
</body>
</html>
