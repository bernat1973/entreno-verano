<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datos Personales - Entreno Verano</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css?v=2" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg" id="main-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">Entreno Verano</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Close">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link active" href="{{ url_for('datos_personales') }}">Datos Personales</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('entreno') }}">Entreno</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('correr') }}">Correr</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('progreso') }}">Progreso</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('resumen') }}">Resumen</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <h1 class="h4 mb-0">Datos Personales</h1>
                </div>
                <div class="card-body">
                    <p class="text-muted">{{ semana_actual }}</p>
                    {% if error %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            {{ error }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endif %}
                    {% if mensaje %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            {{ mensaje }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endif %}

                    <!-- Formulario para cambiar de usuario -->
                    <h3 class="h5 mt-4">Cambiar de Usuario</h3>
                    <form action="{{ url_for('cambiar_usuario') }}" method="post">
                        <div class="mb-3">
                            <label for="usuario" class="form-label">Seleccionar Usuario</label>
                            <select name="usuario" id="usuario" class="form-select" required>
                                <option value="">Selecciona un usuario</option>
                                {% for usuario in usuarios %}
                                    <option value="{{ usuario }}" {% if usuario == nombre %}selected{% endif %}>{{ usuario }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Cambiar Usuario</button>
                    </form>

                    <!-- Formulario para actualizar datos personales y mediciones mensuales -->
                    <h3 class="h5 mt-4">Actualizar Datos Personales y Mediciones</h3>
                    <form action="{{ url_for('datos_personales') }}" method="post">
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre</label>
                            <input type="text" name="nombre" id="nombre" class="form-control" value="{{ nombre }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="peso" class="form-label">Peso (kg)</label>
                            <input type="number" name="peso" id="peso" class="form-control" value="{{ peso }}" step="0.1" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="estatura" class="form-label">Estatura (cm)</label>
                            <input type="number" name="estatura" id="estatura" class="form-control" value="{{ estatura }}" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="talla_sentada" class="form-label">Talla Sentada (cm)</label>
                            <input type="number" name="talla_sentada" id="talla_sentada" class="form-control" value="{{ talla_sentada }}" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="envergadura" class="form-label">Envergadura (cm)</label>
                            <input type="number" name="envergadura" id="envergadura" class="form-control" value="{{ envergadura }}" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="meta_km" class="form-label">Meta de Kil√≥metros Semanal</label>
                            <input type="number" name="meta_km" id="meta_km" class="form-control" value="{{ meta_km }}" step="0.1" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="ejercicios_type" class="form-label">
                                <strong>Tipo de ejercicios:</strong>
                                <small class="text-muted">(Elige seg√∫n tu objetivo)</small>
                            </label>
                            <select name="ejercicios_type" id="ejercicios_type" class="form-control">
                                <option value="bodyweight" {% if ejercicios_type == 'bodyweight' %}selected{% endif %}>
                                    üèÉ‚Äç‚ôÇÔ∏è Sin pesas (Original)
                                </option>
                                <option value="futbol" {% if ejercicios_type == 'futbol' %}selected{% endif %}>
                                    ‚öΩ Sin pesas - Progresiva
                                </option>
                                <option value="weights" {% if ejercicios_type == 'weights' %}selected{% endif %}>
                                    üèãÔ∏è‚Äç‚ôÇÔ∏è Con pesas
                                </option>
                                <option value="mixtos" {% if ejercicios_type == 'mixtos' %}selected{% endif %}>
                                    üí™ Mixtos (Combinaci√≥n)
                                </option>
                            </select>
                            <div class="form-text">
                                <ul style="font-size: 0.9em; margin-top: 10px;">
                                    <li><strong>Sin pesas (Original):</strong> Ejercicios cl√°sicos de peso corporal</li>
                                    <li><strong>Sin pesas - F√∫tbol:</strong> Especial para jugadores de f√∫tbol (explosividad, agilidad, core)</li>
                                    <li><strong>Con pesas:</strong> Entrenamiento con mancuernas y barras</li>
                                    <li><strong>Mixtos:</strong> Combinaci√≥n de pesas y peso corporal</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="mes_medicion" class="form-label">Mes de Medici√≥n</label>
                            <input type="month" name="mes_medicion" id="mes_medicion" class="form-control" value="{{ mes_medicion }}" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar Datos</button>
                    </form>

                    <!-- Sistema de Progresi√≥n -->
                    <div class="alert alert-info mt-3">
                        <h5>üìà Sistema de Progresi√≥n</h5>
                        <p><strong>D√≠as de entrenamiento completados:</strong> {{ modelo.contador_progresion|default(0) }}</p>
                        <div class="progress" style="height: 25px;">
                            {% set progreso_porcentaje = ((modelo.contador_progresion|default(0) / 30) * 100) %}
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ [progreso_porcentaje, 100]|min }}%"
                                 aria-valuenow="{{ modelo.contador_progresion|default(0) }}" 
                                 aria-valuemin="0" aria-valuemax="30">
                                {{ modelo.contador_progresion|default(0) }}/30
                            </div>
                        </div>
                        <small class="text-muted">
                            La dificultad aumenta cada 10 entrenamientos completados (no por d√≠as calendario)
                        </small>
                    </div>

                    <!-- Mostrar m√©tricas calculadas -->
                    <h3 class="h5 mt-4">M√©tricas Calculadas</h3>
                    <p><strong>Segmento Inferior:</strong> {{ segmento_inferior|round(2) }} cm</p>
                    <p><strong>√çndice de Masa Corporal (IMC):</strong> {{ imc|round(2) }}</p>
                    <p><strong>Velocidad de Crecimiento Actual:</strong> {{ velocidad_crecimiento|round(2) }} cm/a√±o</p>

                    <!-- Dos gr√°ficas de evoluci√≥n -->
                    <h3 class="h5 mt-4">Evoluci√≥n de Crecimiento</h3>
                    <div class="grafica-container">
                        <canvas id="estaturaChart"></canvas>
                    </div>
                    <div class="grafica-container mt-4">
                        <canvas id="velocidadChart"></canvas>
                    </div>

                    <!-- Formulario para crear nuevo usuario -->
                    <h3 class="h5 mt-4">Crear Nuevo Usuario</h3>
                    <form action="{{ url_for('nuevo_usuario') }}" method="post">
                        <div class="mb-3">
                            <label for="nuevo_usuario" class="form-label">Nombre del Nuevo Usuario</label>
                            <input type="text" name="nuevo_usuario" id="nuevo_usuario" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-success">Crear Usuario</button>
                    </form>

                    <!-- Enlace para volver al inicio -->
                    <div class="mt-4">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">Volver al Inicio</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SCRIPT PARA INICIALIZAR LAS GR√ÅFICAS CON AJUSTES EN EL EJE Y -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            {% if datos_grafica and datos_grafica|length > 0 %}
                const datosJSON = {{ datos_grafica|tojson|safe }};
                const labels = datosJSON.map(d => d.mes);
                const estaturaData = datosJSON.map(d => d.estatura);
                const velocidadData = datosJSON.map(d => d.velocidad || 0);

                const estaturaCtx = document.getElementById('estaturaChart').getContext('2d');
                new Chart(estaturaCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Estatura (cm)',
                            data: estaturaData,
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Estatura (cm)'
                                },
                                ticks: {
                                    stepSize: 0.5
                                }
                            }
                        }
                    }
                });

                const velocidadCtx = document.getElementById('velocidadChart').getContext('2d');
                new Chart(velocidadCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Crecimiento Mensual (cm)',
                            data: velocidadData,
                            borderColor: '#FF6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Crecimiento Mensual (cm)'
                                },
                                ticks: {
                                    stepSize: 0.5
                                }
                            }
                        }
                    }
                });
            {% endif %}
        });
    </script>
</body>
</html>
